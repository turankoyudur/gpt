diff --git a/server/node-build.ts b/server/node-build.ts
index 1111111..2222222 100644
--- a/server/node-build.ts
+++ b/server/node-build.ts
@@ -1,16 +1,26 @@
 import path from "path";
+import { fileURLToPath } from "url";
 import { createServer } from "./index";
-import * as express from "express";
+import express from "express";
 
 const app = createServer();
-const port = process.env.PORT || 3000;
+const port = Number(process.env.PORT ?? 3000);
 
 // In production, serve the built SPA files
-const __dirname = import.meta.dirname;
-const distPath = path.join(__dirname, "../spa");
+// ESM-safe __dirname (works reliably on Node 18+)
+const __filename = fileURLToPath(import.meta.url);
+const __dirname = path.dirname(__filename);
+const distPath = path.resolve(__dirname, "../spa");
 
 // Serve static files
 app.use(express.static(distPath));
 
 // Handle React Router - serve index.html for all non-API routes
 app.get("*", (req, res) => {
   // Don't serve index.html for API routes
   if (req.path.startsWith("/api/") || req.path.startsWith("/health")) {
     return res.status(404).json({ error: "API endpoint not found" });
   }
 
   res.sendFile(path.join(distPath, "index.html"));
 });
diff --git a/vite.config.server.ts b/vite.config.server.ts
index 3333333..4444444 100644
--- a/vite.config.server.ts
+++ b/vite.config.server.ts
@@ -1,6 +1,11 @@
 import { defineConfig } from "vite";
 import path from "path";
+import { fileURLToPath } from "url";
+
+// ESM-safe __dirname
+const __filename = fileURLToPath(import.meta.url);
+const __dirname = path.dirname(__filename);
 
 // Server build configuration
 export default defineConfig({
   build: {
     lib: {
       entry: path.resolve(__dirname, "server/node-build.ts"),
       name: "server",
-      fileName: "production",
+      fileName: "node-build",
       formats: ["es"],
     },
     outDir: "dist/server",
     target: "node22",
     ssr: true,
     rollupOptions: {
       external: [
         // Node.js built-ins
         "fs",
         "path",
         "url",
         "http",
         "https",
         "os",
         "crypto",
         "stream",
         "util",
         "events",
         "buffer",
         "querystring",
         "child_process",
         // External dependencies that should not be bundled
         "express",
         "cors",
+        "@prisma/client",
+        "prisma",
+        "battleye",
       ],
       output: {
         format: "es",
-        entryFileNames: "[name].mjs",
+        // Stable filename expected by scripts/windows/start.bat
+        entryFileNames: "node-build.mjs",
       },
     },
     minify: false, // Keep readable for debugging
     sourcemap: true,
   },
   resolve: {
     alias: {
       "@": path.resolve(__dirname, "./client"),
       "@shared": path.resolve(__dirname, "./shared"),
     },
   },
   define: {
     "process.env.NODE_ENV": '"production"',
   },
 });
diff --git a/vite.config.client.ts b/vite.config.client.ts
index 5555555..6666666 100644
--- a/vite.config.client.ts
+++ b/vite.config.client.ts
@@ -1,6 +1,11 @@
 import { defineConfig } from "vite";
 import react from "@vitejs/plugin-react-swc";
 import path from "path";
+import { fileURLToPath } from "url";
+
+// ESM-safe __dirname
+const __filename = fileURLToPath(import.meta.url);
+const __dirname = path.dirname(__filename);
 
 export default defineConfig({
   build: {
     outDir: "dist/spa",
   },
   plugins: [react()],
   resolve: {
     alias: {
       "@": path.resolve(__dirname, "./client"),
       "@shared": path.resolve(__dirname, "./shared"),
     },
   },
 });
diff --git a/vite.config.ts b/vite.config.ts
index 7777777..8888888 100644
--- a/vite.config.ts
+++ b/vite.config.ts
@@ -1,7 +1,12 @@
 import { defineConfig, Plugin } from "vite";
 import react from "@vitejs/plugin-react-swc";
 import path from "path";
+import { fileURLToPath } from "url";
 import { createServer } from "./server";
+
+// ESM-safe __dirname
+const __filename = fileURLToPath(import.meta.url);
+const __dirname = path.dirname(__filename);
 
 // https://vitejs.dev/config/
 export default defineConfig(({ mode }) => ({
   server: {
     host: "::",
     port: 8080,
     fs: {
       allow: ["./client", "./shared"],
       deny: [".env", ".env.*", "*.{crt,pem}", "**/.git/**", "server/**"],
     },
   },
   build: {
     outDir: "dist/spa",
   },
   plugins: [react(), expressPlugin()],
   resolve: {
     alias: {
       "@": path.resolve(__dirname, "./client"),
       "@shared": path.resolve(__dirname, "./shared"),
     },
   },
 }));
